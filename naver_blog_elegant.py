import os
import google.generativeai as genai
from datetime import datetime

# ==========================================
# 1. 설정 (Setup)
# ==========================================

api_key = os.environ.get("GOOGLE_API_KEY")

# 블로그 설정 (교양 있고 차분한 톤앤매너)
STUDIO_NAME = "다산 라미 바이올린"
LOCATION = "남양주 다산신도시"
TEACHER_VIBE = "차분하고 우아하며, 아이들을 진심으로 사랑하는 따뜻한 교육자"

# ==========================================
# 2. '품격 있는' 선생님 말투 생성기 (Refined Prompt)
# ==========================================
def generate_real_blog_post(topic, raw_notes):
    
    prompt = f"""
    당신은 {LOCATION}에서 개인 레슨을 운영하는 '{TEACHER_VIBE}' 바이올린 선생님입니다.
    네이버 블로그에 올릴 글을 작성해야 하며, **신뢰감 있고 교양 있는 문체**를 사용해야 합니다.
    
    [입력 소스]
    - 주제: {topic}
    - 선생님의 메모(재료): "{raw_notes}"

    [🎻 핵심 지령: 차분하고 따뜻한 문체]
    1. **톤앤매너**:
       - 가벼운 유행어나 과한 이모지(ㅋㅋㅋ, ㅎㅎ 등)는 절대 사용하지 마세요.
       - 대신 **'~해요', '~했답니다', '~였지요'** 같은 부드럽고 정중한 어미를 사용하세요.
       - 문장은 우아하고 차분하게, 마치 따뜻한 차 한 잔을 앞에 두고 학부모님과 조용히 대화를 나누는 느낌으로 작성하세요.
    
    2. **내용 구성 (흐름)**:
       - **도입**: 계절의 변화나 일상의 소소한 아름다움을 언급하며 차분하게 시작하세요. (예: "창밖으로 스며드는 햇살이 참 따스한 오후입니다.")
       - **전개**: 레슨 중 있었던 아이와의 에피소드를 **관찰자적 시점**에서 깊이 있게 서술하세요. 아이의 성장을 바라보는 선생님의 따뜻한 시선을 담아주세요.
       - **절정**: 기술적인 성취보다는, 아이가 음악을 통해 느끼는 **내면의 성장**이나 **감정의 변화**에 집중하여 묘사하세요.
       - **결말**: 여운을 남기는 마무리와 함께, 교육에 대한 소신을 짧게 덧붙이세요. 문의 유도는 정중하고 간결하게 하세요.

    3. **형식**:
       - 글 중간중간에 `[사진: ~~하는 모습]` 가이드를 적절히 배치하여 현장감을 주세요.
       - 문단은 호흡이 너무 짧지 않게, 적당한 길이감으로 안정감을 주세요.

    [목표]
    이 글을 읽은 학부모가 "이 선생님은 정말 아이를 깊이 있게 생각하시는구나, 교육 철학이 남다르다"라고 느끼게 만드는 것.
    """

    if not api_key:
        return "⚠️ API 키를 먼저 설정해주세요!"

    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-2.0-pro-exp-02-05')
        
        print(f"🎻 선생님(Elegant Ver.) 빙의 중... (주제: {topic})")
        response = model.generate_content(prompt)
        return response.text
        
    except Exception as e:
        return f"❌ 에러가 발생했습니다: {e}"

# ==========================================
# 3. 실행 (Run)
# ==========================================
if __name__ == "__main__":
    print(f"--- {STUDIO_NAME} 블로그 포스팅 도우미 (Elegant Ver.) ---")
    
    # 입력 예시 가이드
    print("팁: 아이의 행동이나 레슨 상황을 구체적으로 적어주시면, 더욱 깊이 있는 글이 완성됩니다.")
    print("예: '오늘 지우가 작은별을 끝까지 연주해냈다. 중간에 포기하지 않고 끝까지 해내는 모습이 대견했다. 연주가 끝나고 수줍게 웃는데 그 모습이 참 예뻤다.'\n")

    topic_in = input("주제 입력 (예: 7살 첫 완곡 후기): ")
    notes_in = input("메모 입력 (카톡 내용 등): ")

    if not topic_in: topic_in = "바이올린 활 잡기를 어려워하는 아이 지도법"
    if not notes_in: notes_in = "엄지에 힘이 너무 들어가 소리가 거칠게 남. 빨대를 이용해 힘을 빼는 연습을 시켰더니 소리가 한결 부드러워짐. 아이도 소리의 변화를 느끼고 즐거워함."

    post = generate_real_blog_post(topic_in, notes_in)

    # 파일 저장
    filename = f"blog_elegant_{datetime.now().strftime('%H%M%S')}.md"
    with open(filename, "w", encoding="utf-8") as f:
        f.write(post)

    print(f"\n✅ 원고 작성이 완료되었습니다. '{filename}' 파일을 확인해 주세요.")
    print("선생님의 교육 철학에 맞게 조금씩 다듬어 사용하시면 됩니다.")